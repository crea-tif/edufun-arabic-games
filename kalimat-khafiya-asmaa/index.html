<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<script>
/* Force l’ouverture sur GitHub Pages (évite le viewer GitHub qui casse CSS/JS) */
(function () {
  var pages = "https://crea-tif.github.io/edufun-arabic-games/";
  var appPath = location.pathname.split("/").slice(-2)[0];
  var host = location.hostname;
  var isBadHost = host === "github.com" ||
                  host === "raw.githubusercontent.com" ||
                  host.endsWith("githubusercontent.com");
  if (isBadHost) {
    var q = location.search || "";
    var h = location.hash || "";
    location.replace(pages + appPath + "/" + q + h);
  }
})();
</script>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>الكلمات الخفية • أسماء الله الحسنى</title>
<!-- le reste de ton fichier inchangé -->

<style>
:root{
  /* Palette “Kids” (vert clair/contrasté) */
  --ink:#0f172a; --accent:#1f7ae0;
  --ok:#16a34a; --warn:#f59e0b;
  --glass: rgba(255,255,255,0.85);
  --bg1:#b9f3d0; --bg2:#31c77a;
  --cell:44px; /* recalculée en JS */
}
*,
*::before,
*::after{ box-sizing:border-box; } /* ✅ empêche les débordements surprises */

/* ===== Fond dégradé + watermark logo ===== */
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:system-ui,-apple-system,"Noto Kufi Arabic","Tajawal","Cairo",Tahoma,Arial;
  background:linear-gradient(35deg,var(--bg1) 0%, var(--bg2) 100%) fixed;
}
body::after{
  content:""; position:fixed; inset:auto 0 16px 16px; width:150px; height:66px; z-index:-1;
  background:url("../edufun-logo-512.png") no-repeat left/contain;
  opacity:.10; pointer-events:none;
}

/* ===== Cartes “verre dépoli” ===== */
header,.card{
  background:var(--glass);
  backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,0.65);
  border-radius:18px;
  box-shadow:0 10px 30px rgba(31,122,224,.18);
}
header{ position:sticky; top:0; z-index:5; margin-bottom:12px; }
.wrap{ max-width:1000px; margin:auto; padding:12px; }

/* Brand + Home */
.brandbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.brand{ display:flex; align-items:center; gap:12px; min-width:0; }
.brand img{ height:56px; border-radius:10px; filter:drop-shadow(0 1px 2px rgba(0,0,0,.18)); flex:0 0 auto; }
h1{ margin:0; font-size:22px; line-height:1.25; }
.home{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 14px; border-radius:12px;
  background:#10b981; color:#fff; text-decoration:none; font-weight:700;
  box-shadow:0 6px 16px rgba(16,185,129,.25);
  white-space:nowrap;
}

/* Barre de commandes */
.controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:8px; }
select,button{ padding:10px 12px; border:1px solid rgba(255,255,255,0.65);
  background:rgba(255,255,255,0.96); border-radius:12px; font-size:14px; }
button.primary{ background:#10b981; border-color:#10b981; color:#fff; box-shadow:0 6px 16px rgba(16,185,129,.25); }

/* Layout */
main .wrap{ display:grid; grid-template-columns:1fr 320px; gap:16px; }

/* Hauteur pilotée JS (fix mobile) + largeur sûre */
.grid-wrap{
  overflow:hidden; height:var(--gridH,70vh);
  width:100%; /* ✅ empêche le débordement horizontal */
}

/* Bonus : si 100dvh dispo, exploite-le */
@supports (height: 100dvh){
  .grid-wrap{ height: calc(100dvh - var(--headH,240px)); }
}

/* ✅ Mobile : header non-collant pour éviter le rognage, padding plus doux */
@media (max-width:900px){
  header{ position:static; }
  .wrap{ padding-inline:8px; }
  main .wrap{ grid-template-columns:1fr; }
  .grid-wrap{ height:var(--gridH,68vh); }
  aside.card{ margin-top:10px; }
  .brand img{ height:52px; }
}

/* ===== Grille ===== */
.grid{
  --n:10;
  display:grid;
  grid-template-columns:repeat(var(--n),var(--cell));
  grid-auto-rows:var(--cell);
  gap:6px; user-select:none; touch-action:none; padding:6px;
  max-width:100%; /* ✅ ne dépasse jamais son conteneur */
}
.cell{
  width:var(--cell); height:var(--cell);
  display:flex; align-items:center; justify-content:center;
  background:#fff; border:1px solid #eaf1fb; border-radius:14px;
  font-weight:800;
  font-size:clamp(16px,calc(var(--cell)*.55),28px);
  transition:transform .12s,background .3s,border-color .3s;
  box-shadow:0 2px 6px rgba(31,122,224,.08);
}
.cell.preview{ outline:2px dashed #1f7ae0; }
.cell.valid-preview{ outline:2px solid var(--warn); }
.cell.hint{ background:#fff3bf; border-color:#ffd04a; box-shadow:inset 0 0 0 2px #ffd04a33, 0 2px 6px rgba(31,122,224,.08); }
.cell.found{ background:#e8f7ee; border-color:#b7e3c8; color:#055a43; }
.cell.flash{ animation:flashOk 1s ease-in-out 3; }
@keyframes flashOk{0%,100%{background:#e8f7ee}50%{background:#16a34a;color:#fff;transform:scale(1.05)}}

.target{ display:flex; flex-wrap:wrap; gap:8px; }
.badge{ background:#fff; border:1px solid #e5eefc; padding:8px 11px; border-radius:999px; font-size:14px; box-shadow:0 1px 3px rgba(31,122,224,.08); }
.badge.found{ background:#e8f7ee; border-color:#b7e3c8; color:#055a43; }
.help{ font-size:13px; color:#29425f; line-height:1.7; }
.footer{ font-size:12px; color:#eef6ff; margin-top:6px; text-shadow:0 1px 2px rgba(0,0,0,.2) }
hr{ border:none; border-top:1px solid #e7f0ff; margin:10px 0; }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="brandbar">
      <div class="brand">
        <img src="../edufun-logo-512.png" alt="EDUFUN">
        <h1>الكلمات الخفية — <span style="color:#0f766e">كلمات حول الأسماء الحسنى</span><br>
          <small style="font-weight:600;color:#155e75">تعلّم ممتع مع مؤثرات مرئية وصوتية</small>
        </h1>
      </div>
      <a class="home" href="../">🏠 الصفحة الرئيسية</a>
    </div>

    <div class="controls">
      <label>المستوى:
        <select id="level"></select>
      </label>
      <label>عدد الكلمات/المستوى:
        <select id="chunk">
          <option value="6">6</option>
          <option value="8" selected>8</option>
          <option value="10">10</option>
          <option value="12">12</option>
        </select>
      </label>
      <label>حجم الشبكة:
        <select id="size">
          <option value="8">8 × 8</option>
          <option value="10" selected>10 × 10</option>
          <option value="12">12 × 12</option>
        </select>
      </label>
      <button id="regen" class="primary">إعادة توليد الشبكة</button>
      <button id="showHints">إظهار/إخفاء تلميحات</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <section class="card grid-wrap">
      <div id="grid" class="grid"></div>
      <div class="footer" id="status"></div>
    </section>

    <aside class="card">
      <h3 id="listTitle">الكلمات المستهدفة</h3>
      <div id="targets" class="target"></div>
      <hr>
      <div class="help">إبحث أفقيًا يمينًا ⟵ يسارًا أو عموديًا أعلى ↓ أسفل. (لا قطريات)</div>
    </aside>
  </div>
</main>

<script>
/* ========= بيانات الكلمات ========= */
const VOCAB = [
  "رحمة","مغفرة","هداية","حكمة","علم","قوة","رزق","نور",
  "صدق","رفق","أمانة","إحسان","وفاء","صبر","بر","عدل"
];

/* ========= DOM ========= */
const gridEl=document.getElementById('grid'),
levelSel=document.getElementById('level'),
sizeSel=document.getElementById('size'),
chunkSel=document.getElementById('chunk'),
targetsEl=document.getElementById('targets'),
statusEl=document.getElementById('status'),
btnRegen=document.getElementById('regen'),
btnHints=document.getElementById('showHints');

/* ========= State ========= */
let N=+sizeSel.value, CHUNK=+chunkSel.value;
let LEVELS=[], cells=[], board=[], isWord=[], targetWords=[], remaining=new Set();
let hintsOn=false;

/* ========= Utils ========= */
const AR_RANDOM="ابتثجحخدذرزسشصضطظعغفقكلمنهوي";
const randLetter=()=>AR_RANDOM[Math.floor(Math.random()*AR_RANDOM.length)];
const normalize=s=>s.replace(/\s+/g,'').replace(/ـ/g,'').replace(/[^\u0600-\u06FF]/g,'');
const idx=(r,c)=>r*N+c, inBounds=(r,c)=>r>=0&&r<N&&c>=0&&c<N;

/* ========= Levels ========= */
function rebuildLevels(){
  LEVELS=[];
  for(let i=0;i<VOCAB.length;i+=CHUNK) LEVELS.push(VOCAB.slice(i,i+CHUNK));
  levelSel.innerHTML='';
  LEVELS.forEach((L,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=`المستوى ${i+1} (${L.length} كلمة)`; levelSel.appendChild(o); });
  levelSel.value=0;
}
rebuildLevels();

/* ========= Grid build ========= */
function buildGrid(){
  gridEl.innerHTML=''; cells=[];
  gridEl.style.setProperty('--n', N);
  for(let i=0;i<N*N;i++){
    const d=document.createElement('div');
    d.className='cell'; d.dataset.index=i;
    gridEl.appendChild(d); cells.push(d);
  }
}

/* ========= Placement (← ou ↓) ========= */
function tryPlace(word){
  const chars=normalize(word).split(''), L=chars.length;
  if(L>N) return false;
  const dirs=[{dr:0,dc:-1},{dr:1,dc:0}];
  for(let t=0;t<420;t++){
    const dir=dirs[Math.random()<.6?0:1];
    let r,c;
    if(dir.dc===-1){ r=Math.floor(Math.random()*N); c=Math.floor(Math.random()*(N-1))+(L-1); }
    else{ r=Math.floor(Math.random()*(N-L)); c=Math.floor(Math.random()*N); }
    let ok=true;
    for(let k=0;k<L;k++){
      const rr=r+dir.dr*k, cc=c+dir.dc*k;
      if(!inBounds(rr,cc) || (board[rr][cc] && board[rr][cc]!==chars[k])){ ok=false; break; }
    }
    if(!ok) continue;
    for(let k=0;k<L;k++){ const rr=r+dir.dr*k, cc=c+dir.dc*k; board[rr][cc]=chars[k]; isWord[rr][cc]=true; }
    return true;
  }
  return false;
}
function pickSubset(a,k){ const x=a.slice(); for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]]; } return x.slice(0,Math.min(k,x.length)); }

/* ========= Generate ========= */
function generate(i){
  const base=LEVELS[i].slice(), eligible=base.filter(n=>normalize(n).length<=N);
  let words=pickSubset(eligible, Math.min(CHUNK, eligible.length));
  words.sort((a,b)=>normalize(b).length-normalize(a).length);

  board=Array.from({length:N},()=>Array(N).fill(null));
  isWord=Array.from({length:N},()=>Array(N).fill(false));
  let placed=true;
  for(const w of words){ if(!tryPlace(w)){ placed=false; break; } }
  if(!placed){
    for(let attempt=0; attempt<3 && !placed; attempt++){
      words.pop();
      board=Array.from({length:N},()=>Array(N).fill(null));
      isWord=Array.from({length:N},()=>Array(N).fill(false));
      placed=true;
      for(const w of words){ if(!tryPlace(w)){ placed=false; break; } }
    }
  }
  for(let r=0;r<N;r++)for(let c=0;c<N;c++) if(!board[r][c]) board[r][c]=randLetter();

  targetWords=words; remaining=new Set(words);
  buildGrid();
  for(let r=0;r<N;r++)for(let c=0;c<N;c++) cells[idx(r,c)].textContent=board[r][c];
  renderTargets(); updateStatus(); refitAll(); applyHints();
}

/* ========= UI (badges) ========= */
function renderTargets(){
  document.getElementById('listTitle').textContent=`الكلمات المستهدفة — (${targetWords.length} كلمة)`;
  targetsEl.innerHTML='';
  targetWords.forEach(n=>{ const b=document.createElement('span'); b.className='badge'; b.dataset.name=n; b.textContent=n; targetsEl.appendChild(b); });
}
function markBadgeFound(n){ [...targetsEl.children].forEach(x=>{ if(x.dataset.name===n) x.classList.add('found'); }); }
function updateStatus(){ statusEl.textContent=`المتبقي: ${remaining.size} / ${targetWords.length}`; }

/* ========= Matching / Preview ========= */
function collectLine(f,t){
  if(f.r===t.r && t.c<=f.c){ const L=[]; for(let c=f.c;c>=t.c;c--) L.push({r:f.r,c}); return L; }
  if(f.c===t.c && t.r>=f.r){ const L=[]; for(let r=f.r;r<=t.r;r++) L.push({r,c:f.c}); return L; }
  return null;
}
function textFrom(L){ let s=''; for(const p of L) s+=board[p.r][p.c]; return s; }
function isExact(L){ const p=textFrom(L); for(const n of remaining) if(normalize(n)===p) return n; return null; }
function isPrefix(L){ const p=textFrom(L); for(const n of remaining){ if(normalize(n).startsWith(p)) return true; } return false; }

/* ========= Sons + confettis ========= */
let actx=null;
function ensureAudio(){ if(!actx){ actx=new (window.AudioContext||window.webkitAudioContext)(); } }
function tone(freq, dur=0.12, type='sine', gain=0.08, when=0){
  ensureAudio();
  const t=actx.currentTime+when, osc=actx.createOscillator(), g=actx.createGain();
  osc.type=type; osc.frequency.value=freq; g.gain.value=gain;
  g.gain.setValueAtTime(gain,t); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  osc.connect(g).connect(actx.destination); osc.start(t); osc.stop(t+dur);
}
function playDing(){ tone(880,0.10,'triangle',0.10,0); tone(1320,0.12,'triangle',0.08,0.07); }
function playWin(){ [660,880,990,1320].forEach((f,i)=>tone(f,0.15,'square',0.09,i*0.08)); confettiBurst(); }
function confettiBurst(){
  const c=document.createElement('canvas'); c.width=innerWidth; c.height=innerHeight;
  Object.assign(c.style,{position:'fixed',inset:'0',pointerEvents:'none',zIndex:9999});
  document.body.appendChild(c);
  const ctx=c.getContext('2d'), pcs=[], cols=['#ff6b6b','#ffd166','#06d6a0','#1f7ae0','#8338ec'];
  for(let i=0;i<160;i++) pcs.push({x:Math.random()*c.width,y:-20-Math.random()*200,r:6+Math.random()*6,col:cols[(Math.random()*cols.length)|0],vx:-1+Math.random()*2,vy:2+Math.random()*2,rot:Math.random()*Math.PI,vr:(-0.1+Math.random()*0.2)});
  let t=0; (function a(){ ctx.clearRect(0,0,c.width,c.height);
    pcs.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.rot+=p.vr; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.col; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore(); });
    if(t++<180) requestAnimationFrame(a); else c.remove();
  })();
}

/* ========= Sélection fiable (mobile/PC) ========= */
let start=null, lastPreview=[];
function posFromEl(el){ const i=+el.dataset.index; return {r:Math.floor(i/N), c:i%N}; }
function clearPreview(){ lastPreview.forEach(p=>cells[idx(p.r,p.c)].classList.remove('preview','valid-preview')); lastPreview=[]; }
function setPreview(L, exact=false){
  clearPreview(); if(!L) return;
  L.forEach(p=>cells[idx(p.r,p.c)].classList.add(exact?'valid-preview':'preview'));
  lastPreview=L.slice();
}

gridEl.addEventListener('pointerdown', e=>{
  const t=e.target.closest('.cell'); if(!t) return;
  ensureAudio();
  e.preventDefault();
  gridEl.setPointerCapture(e.pointerId);
  start=posFromEl(t);
  setPreview([start], false);
}, {passive:false});

gridEl.addEventListener('pointermove', e=>{
  if(!start) return;
  const el=document.elementFromPoint(e.clientX, e.clientY);
  const cell=(el && el.classList && el.classList.contains('cell'))? el : e.target.closest('.cell');
  if(!cell) return;
  const end=posFromEl(cell);
  const L=collectLine(start,end);
  if(!L){ clearPreview(); return; }
  const exact=isExact(L);
  if(exact){ setPreview(L, true); }
  else if(isPrefix(L)){ setPreview(L, false); }
  else{ clearPreview(); }
}, {passive:false});

function commitIfValid(e){
  if(!start || !lastPreview.length) { start=null; return; }
  const exactName=isExact(lastPreview);
  if(exactName){
    remaining.delete(exactName);
    lastPreview.forEach(p=>gridEl.children[idx(p.r,p.c)].classList.add('found','flash'));
    markBadgeFound(exactName); updateStatus(); playDing();
    if(remaining.size===0){ statusEl.textContent="أحسنت! ✅"; playWin(); }
    applyHints();
  }
  clearPreview(); start=null;
  if(e && e.pointerId) { try{ gridEl.releasePointerCapture(e.pointerId); }catch{} }
}
gridEl.addEventListener('pointerup',    commitIfValid, {passive:true});
gridEl.addEventListener('pointercancel',()=>{ clearPreview(); start=null; });

/* ========= TIPS ========= */
function applyHints(){
  for(let r=0;r<N;r++){
    for(let c=0;c<N;c++){
      const i=idx(r,c), el=cells[i], found=el.classList.contains('found');
      el.classList.toggle('hint', hintsOn && isWord[r][c] && !found);
    }
  }
}
btnHints.onclick=()=>{ hintsOn=!hintsOn; btnHints.setAttribute('aria-pressed', hintsOn?'true':'false'); applyHints(); };

/* ========= Recalc responsive (fix Android A06 & co) ========= */
function sizeGridWrap(){
  // Hauteurs candidates
  const ih = window.innerHeight || 0;
  const ch = document.documentElement.clientHeight || 0;
  const vv = (window.visualViewport && window.visualViewport.height) || 0;
  const viewportH = Math.max(ih, ch, vv || 0); // prends le plus grand disponible

  const header = document.querySelector('header');
  const headerH = header ? header.offsetHeight : 0; // ✅ plus robuste que getBoundingClientRect()
  document.documentElement.style.setProperty('--headH', headerH + 'px');

  // marge de respiration
  const H = Math.max(280, viewportH - headerH - 20);
  gridEl.parentElement.style.setProperty('--gridH', H + 'px');
}
function fitGrid(){
  const wrap=gridEl.parentElement;
  const W=wrap.clientWidth - 4;         // largeur utile
  const H=wrap.clientHeight - 4;        // hauteur utile
  const gap=6;                          // même que CSS .grid{gap:6px}
  const cW=(W-gap*(N-1))/N;
  const cH=(H-gap*(N-1))/N;
  const px=Math.floor(Math.max(22, Math.min(cW, cH)));
  document.documentElement.style.setProperty('--cell', px+'px');
}
function refitAll(){ sizeGridWrap(); fitGrid(); }

/* Écouteurs robustes (Android barre d’adresse dynamique) */
addEventListener('resize', refitAll);
addEventListener('orientationchange', refitAll);
addEventListener('pageshow', refitAll);
if (window.visualViewport){
  visualViewport.addEventListener('resize', refitAll);
  visualViewport.addEventListener('scroll', refitAll);
}

/* ========= UI Events ========= */
btnRegen.onclick=()=>generate(+levelSel.value);
sizeSel.onchange=()=>{ N=+sizeSel.value; generate(+levelSel.value); };
chunkSel.onchange=()=>{ CHUNK=+chunkSel.value; rebuildLevels(); generate(+levelSel.value); };
levelSel.onchange=()=>generate(+levelSel.value);

/* ========= Start ========= */
generate(0);
/* deux passes : la seconde après layout pour appareils facétieux */
refitAll();
setTimeout(refitAll, 0);
</script>
</body>
</html>
