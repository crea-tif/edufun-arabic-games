<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>الكلمات الخفية للأطفال</title>
<style>
:root{ --ink:#0f172a; --accent:#10b981; --ok:#16a34a; --warn:#f59e0b;
       --bg1:#ecfff5; --bg2:#bff7d4; --glass:rgba(255,255,255,.9); --cell:44px; }
html,body{height:100%}
body{margin:0;color:var(--ink);font-family:system-ui,-apple-system,"Noto Kufi Arabic","Cairo",Tahoma,Arial;
  background:radial-gradient(1200px 700px at 70% -80%,var(--bg2),transparent 70%),
             radial-gradient(1000px 600px at -20% 50%,var(--bg2),transparent 60%),
             linear-gradient(35deg,#cffff0 0%,#b6f3d3 40%,#73e2a7 100%) fixed;}
/* logo discret fond */
body::after{content:"";position:fixed;inset:auto 16px 16px auto;width:72px;height:72px;z-index:0;
  background:url("/edufun-arabic-games/edufun-logo-512.png?v=1") center/contain no-repeat;opacity:.14;pointer-events:none;}
header,.card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid #fff7;border-radius:18px;box-shadow:0 10px 30px #10b9812e}
header{ /* pas sticky pour écarter tout risque d’overlay sur la grille */
  position:static; margin:10px 0 12px; z-index:5;
}
.wrap{max-width:1100px;margin:auto;padding:12px}
.brandbar{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.brand{height:56px;filter:drop-shadow(0 2px 4px #0002)}
h1{font-size:22px;margin:0}.sub{font-size:13px;color:#166a4b}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
select,button,.home,label.chk{padding:10px 12px;border:1px solid #00000010;background:#fff;border-radius:12px;font-size:14px}
button.primary{background:#10b981;border-color:#10b981;color:#fff;box-shadow:0 6px 16px #10b98140}
.home{display:inline-flex;align-items:center;gap:8px;text-decoration:none;color:#065f46;background:#eafff2;border-color:#bbf7d0}
.home::before{content:"🏠"} label.chk{display:inline-flex;align-items:center;gap:8px}
label.chk input{accent-color:#10b981;transform:scale(1.1)}
main .wrap{display:grid;grid-template-columns:1fr 320px;gap:16px}
.grid-wrap{overflow:hidden;height:var(--gridH,70vh)}
@media (max-width:900px){main .wrap{grid-template-columns:1fr}}
.grid{--n:10;display:grid;grid-template-columns:repeat(var(--n),var(--cell));grid-auto-rows:var(--cell);gap:6px;
  user-select:none;touch-action:none;padding:8px}
.cell{width:var(--cell);height:var(--cell);border-radius:20px;background:#fff;border:1px solid #eaf1fb;
  display:flex;align-items:center;justify-content:center;font-size:clamp(16px,calc(var(--cell)*.55),28px);
  font-weight:800;transition:transform .12s,background .3s,border-color .3s;box-shadow:0 2px 6px #1f7ae014}
.cell.preview{outline:2px dashed #10b981}.cell.valid-preview{outline:2px solid var(--warn)}
.cell.hint{background:#fff9db;border-color:#ffe08a}.cell.found{background:#e8f7ee;border-color:#b7e3c8;color:#055a43}
.cell.flash{animation:flashOk 1s ease-in-out 3}@keyframes flashOk{0%,100%{background:#e8f7ee}50%{background:#16a34a;color:#fff;transform:scale(1.05)}}
.target{display:flex;flex-wrap:wrap;gap:8px}
.badge{background:#fff;border:1px solid #e5eefc;padding:8px 11px;border-radius:999px;font-size:14px;box-shadow:0 1px 3px #1f7ae014}
.badge.found{background:#e8f7ee;border-color:#b7e3c8;color:#055a43}
.help{font-size:13px;color:#28555d;line-height:1.7}.footer{font-size:12px;color:#0e5135;margin-top:6px}
hr{border:none;border-top:1px solid #e7f0ff;margin:10px 0}
.badgeBuild{font-size:12px;background:#eafff2;border:1px solid #bbf7d0;padding:.25rem .5rem;border-radius:8px;margin-inline-start:auto}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brandbar">
      <a class="home" href="/edufun-arabic-games/">الصفحة الرئيسية</a>
      <img class="brand" src="/edufun-arabic-games/edufun-logo-512.png?v=1" alt="EDUFUN">
      <div>
        <h1>الكلمات الخفية للأطفال</h1>
        <div class="sub">مستويات ممتعة وسهلة</div>
      </div>
      <span class="badgeBuild">Build r7</span>
    </div>
    <div class="controls">
      <label>الفئة: <select id="category"></select></label>
      <label>الصعوبة: <select id="difficulty"><option value="easy">سهل</option><option value="med">متوسط</option><option value="hard">صعب</option></select></label>
      <label>عدد الكلمات/المستوى: <select id="chunk"><option value="6" selected>6</option><option value="8">8</option><option value="10">10</option></select></label>
      <label>حجم الشبكة: <select id="size"><option value="8">8 × 8</option><option value="10" selected>10 × 10</option><option value="12">12 × 12</option></select></label>
      <label class="chk"><input type="checkbox" id="diag"> السماح بالقطريات</label>
      <button id="regen" class="primary">شبكة جديدة</button>
      <button id="showHints">تلميحات</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <section class="card grid-wrap">
      <div id="grid" class="grid"></div>
      <div class="footer" id="status"></div>
    </section>
    <aside class="card">
      <h3 id="listTitle">الكلمات المستهدفة</h3>
      <div id="targets" class="target"></div>
      <hr>
      <div class="help">اضغط على الحرف الأول ثم اسحب إلى الأخير. الاتجاهات: يمين/يسار ↔، أعلى/أسفل ↕، والقطريات إذا فُعّلت.</div>
    </aside>
  </div>
</main>

<script>
/* catégories */
const CATEGORIES={
  "الألوان":["أحمر","أزرق","أصفر","وردي","بنفسجي","برتقالي","أخضر","أبيض","أسود","بني","رمادي"],
  "الحيوانات":["قطة","كلب","حصان","عصفور","سمك","نحل","بقرة","أسد","ذئب","فيل","أرنب","زرافة"],
  "الخضار":["طماطم","خيار","بطاطس","جزر","فلفل","بصل","ثوم","خس","سبانخ","باذنجان"],
  "الفواكه":["تفاح","موز","برتقال","عنب","كرز","كمثرى","خوخ","رمان","بطيخ","فراولة"],
  "الأشكال":["دائرة","مربع","مثلث","مستطيل","نجمة","قلب","بيضاوي"],
  "وسائل النقل":["سيارة","حافلة","قطار","طائرة","دراجة","سفينة","مترو"],
  "الأدوات المدرسية":["قلم","ممحاة","مسطرة","دفتر","كتاب","حقيبة","مبراة","مسطرين"]
};
const AR_RANDOM="ابتثجحخدذرزسشصضطظعغفقكلمنهوي";
const randLetter=()=>AR_RANDOM[Math.floor(Math.random()*AR_RANDOM.length)];
const normalize=s=>s.replace(/\s+/g,'').replace(/ـ/g,'').replace(/[^\u0600-\u06FF]/g,'');

const gridEl=document.getElementById('grid'), statusEl=document.getElementById('status'),
      targetsEl=document.getElementById('targets'), listTitle=document.getElementById('listTitle'),
      selCat=document.getElementById('category'), selDiff=document.getElementById('difficulty'),
      selSize=document.getElementById('size'), selChunk=document.getElementById('chunk'),
      chkDiag=document.getElementById('diag'), btnHints=document.getElementById('showHints'),
      btnRegen=document.getElementById('regen');

Object.keys(CATEGORIES).forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=k;selCat.appendChild(o);});

let N=+selSize.value, CHUNK=+selChunk.value, allowDiag=false, hintsOn=false;
let cells=[], board=[], isWord=[], targets=[], remaining=new Set();

const idx=(r,c)=>r*N+c, inBounds=(r,c)=>r>=0&&r<N&&c>=0&&c<N;

/* DOM grid */
function buildGrid(){ gridEl.style.setProperty('--n',N); gridEl.innerHTML=''; cells=[];
  for(let i=0;i<N*N;i++){const d=document.createElement('div'); d.className='cell'; d.dataset.index=i; gridEl.appendChild(d); cells.push(d);}
}

/* directions + placement */
const directions = ()=> allowDiag
  ? [{dr:0,dc:1},{dr:0,dc:-1},{dr:1,dc:0},{dr:-1,dc:0},{dr:1,dc:1},{dr:1,dc:-1},{dr:-1,dc:1},{dr:-1,dc:-1}]
  : [{dr:0,dc:1},{dr:0,dc:-1},{dr:1,dc:0},{dr:-1,dc:0}];

function tryPlace(word){
  const chars=normalize(word).split(''), L=chars.length; if(L>N) return false;
  const dirs=directions();
  for(let t=0;t<520;t++){
    const dir=dirs[(Math.random()*dirs.length)|0];
    let r=Math.floor(Math.random()*N), c=Math.floor(Math.random()*N);
    if(dir.dc===1)  c=Math.floor(Math.random()*(N-L+1));
    if(dir.dc===-1) c=(Math.floor(Math.random()*(N-L+1)))+(L-1);
    if(dir.dr===1)  r=Math.floor(Math.random()*(N-L+1));
    if(dir.dr===-1) r=(Math.floor(Math.random()*(N-L+1)))+(L-1);
    let ok=true;
    for(let k=0;k<L;k++){ const rr=r+dir.dr*k, cc=c+dir.dc*k;
      if(!inBounds(rr,cc) || (board[rr][cc] && board[rr][cc]!==chars[k])){ ok=false; break; } }
    if(!ok) continue;
    for(let k=0;k<L;k++){ const rr=r+dir.dr*k, cc=c+dir.dc*k; board[rr][cc]=chars[k]; isWord[rr][cc]=true; }
    return true;
  } return false;
}
function pickSubset(a,k){const x=a.slice();for(let i=x.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[x[i],x[j]]=[x[j],x[i]]}return x.slice(0,Math.min(k,x.length))}

/* génération */
function generate(){
  const pool=CATEGORIES[selCat.value]||[];
  let desired=CHUNK; if(selDiff.value==='med') desired=Math.min(CHUNK+1,pool.length); if(selDiff.value==='hard') desired=Math.min(CHUNK+2,pool.length);
  const eligible=pool.filter(n=>normalize(n).length<=N);
  let words=pickSubset(eligible,desired).sort((a,b)=>normalize(b).length-normalize(a).length);
  board=Array.from({length:N},()=>Array(N).fill(null)); isWord=Array.from({length:N},()=>Array(N).fill(false));
  let placed=true; for(const w of words){ if(!tryPlace(w)){ placed=false; break; } }
  if(!placed){ for(let a=0;a<4 && !placed;a++){ words.pop(); board=Array.from({length:N},()=>Array(N).fill(null));
    isWord=Array.from({length:N},()=>Array(N).fill(false)); placed=true; for(const w of words){ if(!tryPlace(w)){ placed=false; break; } } } }
  for(let r=0;r<N;r++)for(let c=0;c<N;c++) if(!board[r][c]) board[r][c]=randLetter();
  targets=words; remaining=new Set(words); buildGrid(); for(let r=0;r<N;r++)for(let c=0;c<N;c++) cells[idx(r,c)].textContent=board[r][c];
  renderTargets(); updateStatus(); refitAll(); applyHints();
}
function renderTargets(){ listTitle.textContent=`الكلمات المستهدفة (${targets.length}) — ${selCat.value}`;
  targetsEl.innerHTML=''; targets.forEach(n=>{const b=document.createElement('span');b.className='badge';b.dataset.name=n;b.textContent=n;targetsEl.appendChild(b);}); }
const markBadgeFound=n=>{[...targetsEl.children].forEach(x=>{if(x.dataset.name===n)x.classList.add('found');})}
const updateStatus=()=>statusEl.textContent=`المتبقي: ${remaining.size} / ${targets.length}`;

/* matching */
function collectLine(f,t){
  const dr=Math.sign(t.r-f.r), dc=Math.sign(t.c-f.c);
  const adr=Math.abs(t.r-f.r), adc=Math.abs(t.c-f.c);
  if(!allowDiag && !(f.r===t.r || f.c===t.c)) return null;
  if(allowDiag && !(f.r===t.r || f.c===t.c || adr===adc)) return null;
  const len=Math.max(adr,adc)+1; const L=[]; let r=f.r,c=f.c; for(let k=0;k<len;k++){ L.push({r,c}); r+=dr; c+=dc; } return L;
}
const textFrom=L=>L.map(p=>board[p.r][p.c]).join('');
const isExact=L=>{const p=textFrom(L); for(const n of remaining) if(normalize(n)===p) return n; return null;}
const isPrefix=L=>{const p=textFrom(L); for(const n of remaining) if(normalize(n).startsWith(p)) return true; return false;}

/* WebAudio */
let actx=null; const ensureAudio=()=>{if(!actx) actx=new (window.AudioContext||window.webkitAudioContext)();}
function tone(f,d=.12,t='sine',g=.08,w=0){ensureAudio(); const ct=actx.currentTime+w, o=actx.createOscillator(), ga=actx.createGain();
o.type=t;o.frequency.value=f;ga.gain.value=g;ga.gain.setValueAtTime(g,ct);ga.gain.exponentialRampToValueAtTime(0.0001,ct+d);
o.connect(ga).connect(actx.destination);o.start(ct);o.stop(ct+d);}
const clickFx=()=>tone(520,.06,'triangle',.09,0);
const playDing=()=>{tone(880,.10,'triangle',.10,0);tone(1320,.12,'triangle',.08,.07);}
function playWin(){[660,880,990,1320].forEach((f,i)=>tone(f,.15,'square',.09,i*.08));confettiBurst();}
function confettiBurst(){const c=document.createElement('canvas');c.width=innerWidth;c.height=innerHeight;
Object.assign(c.style,{position:'fixed',inset:'0',pointerEvents:'none',zIndex:9999});document.body.appendChild(c);
const ctx=c.getContext('2d'),pcs=[],cols=['#ff6b6b','#ffd166','#06d6a0','#10b981','#1f7ae0','#9333ea'];
for(let i=0;i<160;i++)pcs.push({x:Math.random()*c.width,y:-20-Math.random()*200,r:6+Math.random()*6,col:cols[(Math.random()*cols.length)|0],vx:-1+Math.random()*2,vy:2+Math.random()*2,rot:Math.random()*Math.PI,vr:(-0.1+Math.random()*0.2)});
let t=0;(function a(){ctx.clearRect(0,0,c.width,c.height);pcs.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.05;p.rot+=p.vr;ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);ctx.fillStyle=p.col;ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r);ctx.restore();});
if(t++<180)requestAnimationFrame(a);else c.remove();})();}

/* interaction robuste */
let start=null,lastPreview=[];
const posFromEl=el=>{const i=+el.dataset.index;return {r:Math.floor(i/N),c:i%N};}
const clearPreview=()=>{lastPreview.forEach(p=>cells[idx(p.r,p.c)].classList.remove('preview','valid-preview'));lastPreview=[];}
function setPreview(L,ok=false){clearPreview();if(!L)return;L.forEach(p=>cells[idx(p.r,p.c)].classList.add(ok?'valid-preview':'preview'));lastPreview=L.slice();}
gridEl.addEventListener('pointerdown',e=>{const t=e.target.closest('.cell');if(!t)return;ensureAudio();clickFx();e.preventDefault();gridEl.setPointerCapture(e.pointerId);start=posFromEl(t);setPreview([start],false);});
gridEl.addEventListener('pointermove',e=>{if(!start)return;const el=document.elementFromPoint(e.clientX,e.clientY);
const cell=(el&&el.classList&&el.classList.contains('cell'))?el:e.target.closest('.cell');if(!cell)return;const end=posFromEl(cell);
const L=collectLine(start,end);if(!L){clearPreview();return;}const exact=isExact(L);if(exact)setPreview(L,true);else if(isPrefix(L))setPreview(L,false);else clearPreview();});
function commitIfValid(){if(!start||!lastPreview.length)return;const exactName=isExact(lastPreview);if(exactName){remaining.delete(exactName);
lastPreview.forEach(p=>gridEl.children[idx(p.r,p.c)].classList.add('found','flash'));markBadgeFound(exactName);updateStatus();playDing();if(remaining.size===0){statusEl.textContent="رائع! ✅";playWin();}applyHints();}
clearPreview();start=null;}
gridEl.addEventListener('pointerup',commitIfValid);gridEl.addEventListener('pointercancel',()=>{clearPreview();start=null;});

/* hints & contrôles */
function applyHints(){for(let r=0;r<N;r++)for(let c=0;c<N;c++){const i=idx(r,c),el=cells[i],f=el.classList.contains('found');el.classList.toggle('hint',hintsOn&&isWord[r][c]&&!f);}}
btnHints.onclick=()=>{hintsOn=!hintsOn;btnHints.setAttribute('aria-pressed',hintsOn?'true':'false');applyHints();};
selSize.onchange=()=>{N=+selSize.value;generate();}; selChunk.onchange=()=>{CHUNK=+selChunk.value;generate();};
selCat.onchange=generate; selDiff.onchange=generate; chkDiag.onchange=()=>{allowDiag=chkDiag.checked;generate();}; btnRegen.onclick=generate;

/* fit */
function sizeGridWrap(){const header=document.querySelector('header');const wrap=gridEl.parentElement;
const H=Math.max(280,window.innerHeight-header.getBoundingClientRect().height-32);wrap.style.setProperty('--gridH',H+'px');}
function fitGrid(){const wrap=gridEl.parentElement,styles=getComputedStyle(gridEl);const gap=parseFloat(styles.gap)||0,W=wrap.clientWidth-4,H=wrap.clientHeight-4;
const cW=(W-gap*(N-1))/N,cH=(H-gap*(N-1))/N;document.documentElement.style.setProperty('--cell',Math.floor(Math.max(22,Math.min(cW,cH)))+'px');}
function refitAll(){sizeGridWrap();fitGrid();} addEventListener('resize',refitAll); new ResizeObserver(refitAll).observe(document.body);

/* init */
allowDiag=false; selCat.value="الألوان"; console.log("KIDS BUILD r7"); generate(); refitAll();
</script>
</body>
</html>
