<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>الكلمات الخفية للأطفال</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap');
@font-face{
  font-family:"NotoKufiArabicLocal";
  src:url("../assets/NotoKufiArabic.ttf") format("truetype");
  font-display:swap;
}

:root{
  --ink:#0f172a; --accent:#22c55e; --ok:#16a34a; --warn:#f59e0b;
  --glass: rgba(255,255,255,0.9);
  --cell: 48px;

  --brand:#22c55e;        /* أخضر مبهج للأطفال */
  --brand-deep:#16a34a;
  --muted:#29425f;
}

html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:"Tajawal","NotoKufiArabicLocal","Noto Kufi Arabic","Cairo",system-ui,-apple-system,"Segoe UI",Tahoma,Arial;
  background: radial-gradient(1000px 600px at 20% -10%, #d1fae5, transparent 60%), linear-gradient(35deg,#99f6e4 0%, #22c55e 100%) fixed;
}
body::after{
  content:""; position:fixed; inset:auto 0 16px 16px; width:160px; height:70px; z-index:-1;
  background:url("edufun-logo-512.png") no-repeat left/contain; opacity:.12; pointer-events:none;
}

header, .card{
  background: var(--glass);
  backdrop-filter: blur(10px);
  border:1px solid rgba(255,255,255,0.7);
  border-radius:18px;
  box-shadow:0 10px 30px rgba(34,197,94,.18);
}
header{position:sticky;top:0;z-index:5;margin-bottom:12px;}
.wrap{max-width:1100px;margin:auto;padding:12px}

/* Header */
.brandbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.brandbox{ display:flex; align-items:center; gap:14px; }
.brand{ height:56px; width:auto; border-radius:14px; filter:drop-shadow(0 4px 12px rgba(0,0,0,.2)); }
.brand-title{ line-height:1.1; }
.brand-title .t1{ font-weight:800; font-size:clamp(20px,3.2vw,30px); color:#064e3b; background:#bbf7d0; padding:6px 12px; border-radius:10px; }
.brand-title .t2{ margin-top:6px; font-weight:700; color:#065f46; font-size:clamp(14px,2.2vw,18px); }
.brand-cta{
  display:inline-flex; align-items:center; gap:10px;
  background:#22c55e; color:#fff; border:none; border-radius:12px;
  padding:10px 14px; font-weight:800; cursor:pointer; box-shadow:0 8px 22px rgba(34,197,94,.28);
}
.brand-cta:hover{ background:#16a34a }

/* Controls */
.controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:12px }
select,button{
  padding:10px 12px;border:1px solid rgba(255,255,255,0.7);
  background:rgba(255,255,255,0.96);border-radius:12px;font-size:16px
}
button.primary{ background:#22c55e;border-color:#22c55e;color:#fff; box-shadow:0 6px 16px rgba(34,197,94,.25) }

main .wrap{display:grid;grid-template-columns:1fr 340px;gap:16px}
.grid-wrap{overflow:hidden;height:var(--gridH,70vh);}
@media (max-width:1000px){
  main .wrap{ grid-template-columns:1fr; }
  aside.card{ order:2; }
}
@media (max-width:900px){
  header{ position: static; margin-bottom:12px; }
  .controls{ gap:6px; }
  .grid-wrap{ margin-top:0; height:var(--gridH,68vh); }
}

/* Grid */
.grid{ --n:8; display:grid; grid-template-columns:repeat(var(--n),var(--cell)); grid-auto-rows:var(--cell); gap:6px; user-select:none; touch-action:none; padding:8px; }
.cell{
  width:var(--cell);height:var(--cell);
  border-radius:18px;background:#fff;border:2px solid #eaf1fb;
  display:flex;align-items:center;justify-content:center;
  font-size:clamp(20px,calc(var(--cell)*.56),30px);
  font-weight:800;transition:transform .12s,background .3s,border-color .3s;
  box-shadow:0 3px 8px rgba(34,197,94,.10);
}
.cell.preview{ outline:3px dashed #22c55e; }
.cell.valid-preview{ outline:3px solid #f59e0b; }
.cell.hint{ background:#fff7d6; border-color:#ffd04a; }
.cell.found{background:#dcfce7;border-color:#86efac;color:#065f46}
.cell.flash{animation:flashOk 1s ease-in-out 3}
@keyframes flashOk{0%,100%{background:#dcfce7}50%{background:#22c55e;color:#fff;transform:scale(1.05)}}

.target{display:flex;flex-wrap:wrap;gap:8px}
.badge{background:#fff;border:1px solid #e5eefc;padding:10px 12px;border-radius:999px;font-size:16px;box-shadow:0 1px 3px rgba(34,197,94,.08)}
.badge.found{background:#dcfce7;border-color:#86efac;color:#065f46}
.help{font-size:15px;color:#065f46;line-height:1.7}
.footer{font-size:14px;color:#064e3b;margin-top:6px;text-shadow:0 1px 2px rgba(0,0,0,.08)}
hr{border:none;border-top:1px solid #e7f0ff;margin:10px 0}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="brandbar" dir="rtl">
      <div class="brandbox">
        <img class="brand" src="edufun-logo-512.png" alt="EDUFUN">
        <div class="brand-title">
          <div class="t1">الكلمات الخفية للأطفال</div>
          <div class="t2">مستويات ممتعة وسهلة</div>
        </div>
      </div>
      <button class="brand-cta" onclick="location.href='../'">الصفحة الرئيسية</button>
    </div>

    <div class="controls">
      <label>الفئة:
        <select id="category">
          <option value="animals">الحيوانات</option>
          <option value="colors" selected>الألوان</option>
          <option value="fruits">الفواكه</option>
          <option value="vegetables">الخضر</option>
          <option value="transport">وسائل النقل</option>
          <option value="school">المدرسة</option>
          <option value="jobs">المهن</option>
          <option value="shapes">الأشكال</option>
        </select>
      </label>

      <label>الصعوبة:
        <select id="difficulty">
          <option value="easy" selected>سهل</option>
          <option value="medium">متوسط</option>
          <option value="hard">صعب</option>
        </select>
      </label>

      <label>عدد الكلمات/المستوى:
        <select id="chunk">
          <option value="6" selected>6</option>
          <option value="8">8</option>
          <option value="10">10</option>
        </select>
      </label>

      <label>حجم الشبكة:
        <select id="size">
          <option value="8" selected>8 × 8</option>
          <option value="10">10 × 10</option>
          <option value="12">12 × 12</option>
        </select>
      </label>

      <button id="regen" class="primary">شبكة جديدة</button>
      <button id="showHints">تلميحات</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <section class="card grid-wrap">
      <div id="grid" class="grid"></div>
      <div class="footer" id="status"></div>
    </section>

    <aside class="card">
      <h3 id="listTitle">الكلمات المستهدفة</h3>
      <div id="targets" class="target"></div>
      <hr>
      <div class="help">
        اضغط على الحرف الأول ثم اسحب إلى الأخير. الاتجاهات: يمين ⇠ يسار أو أعلى ⇣ أسفل.
      </div>
    </aside>
  </div>
</main>

<script>
/* ——— القوائم حسب الفئة ——— */
const CATEGORIES={
  animals: ["قطة","كلب","حصان","سمك","عصفور","نحل","أسد","ثعلب","بقرة","جمل","ذئب","غزال","حمار","فار","قرد"],
  colors:  ["أحمر","أزرق","أخضر","أصفر","وردي","برتقالي","بنفسجي","أسود","أبيض","بني","ذهبي","فضي"],
  fruits:  ["تفاح","موز","برتقال","عنب","فراولة","أناناس","كرز","بطيخ","كمثرى","رمان","توت","خوخ","ليمون"],
  vegetables:["طماطم","خيار","جزر","بطاطا","بصل","ثوم","فلفل","قرع","خس","كرنب","سبانخ","فول"],
  transport:["سيارة","حافلة","قطار","طائرة","دراجة","سفينة","قارب","شاحنة","مترو","ترام"],
  school:  ["قلم","ممحاة","دفتر","كتاب","مسطرة","حقيبة","مبراة","ألوان","كرسي","طاولة","سبورة","طبشور"],
  jobs:    ["طبيب","معلم","مهندس","ممرض","طيار","بحار","نجار","حداد","سائق","فلاح","خباز","شرطي"],
  shapes:  ["دائرة","مربع","مثلث","مستطيل","نجمة","قلب","معين","بيضاوي","شكل","مضلع"]
};

/* ===== محرّك اللعبة ===== */
const gridEl=document.getElementById('grid'),
levelSel=null,                       // غير مستخدم هنا
sizeSel=document.getElementById('size'),
chunkSel=document.getElementById('chunk'),
targetsEl=document.getElementById('targets'),
statusEl=document.getElementById('status'),
btnRegen=document.getElementById('regen'),
btnHints=document.getElementById('showHints'),
categorySel=document.getElementById('category'),
difficultySel=document.getElementById('difficulty');

let ALL_NAMES=CATEGORIES[categorySel.value].slice();
let N=+sizeSel.value, CHUNK=+chunkSel.value;
let LEVELS=[], cells=[], board=[], isWord=[], targetNames=[], remaining=new Set();
let hintsOn=false;

const AR_RANDOM="ابتثجحخدذرزسشصضطظعغفقكلمنهوي";
const randLetter=()=>AR_RANDOM[Math.floor(Math.random()*AR_RANDOM.length)];
const normalize=s=>s.replace(/\s+/g,'').replace(/ـ/g,'').replace(/[^\u0600-\u06FF]/g,'');
const idx=(r,c)=>r*N+c, inBounds=(r,c)=>r>=0&&r<N&&c>=0&&c<N;

function rebuildLevels(){
  LEVELS=[];
  for(let i=0;i<ALL_NAMES.length;i+=CHUNK) LEVELS.push(ALL_NAMES.slice(i,i+CHUNK));
}
rebuildLevels();

function buildGrid(){
  gridEl.innerHTML=''; cells=[];
  for(let i=0;i<N*N;i++){const d=document.createElement('div');d.className='cell';d.dataset.index=i;gridEl.appendChild(d);cells.push(d);}
}

function tryPlace(word){
  const chars=normalize(word).split(''), L=chars.length;
  if(L>N) return false;
  const dirs=[{dr:0,dc:-1},{dr:1,dc:0}];
  for(let t=0;t<420;t++){
    const dir=dirs[Math.random()<.6?0:1];
    let r,c;
    if(dir.dc===-1){ r=Math.floor(Math.random()*N); c=Math.floor(Math.random()*(N-1))+(L-1); }
    else{ r=Math.floor(Math.random()*(N-L)); c=Math.floor(Math.random()*N); }
    let ok=true;
    for(let k=0;k<L;k++){
      const rr=r+dir.dr*k, cc=c+dir.dc*k;
      if(!inBounds(rr,cc) || (board[rr][cc] && board[rr][cc]!==chars[k])){ ok=false; break; }
    }
    if(!ok) continue;
    for(let k=0;k<L;k++){ const rr=r+dir.dr*k, cc=c+dir.dc*k; board[rr][cc]=chars[k]; isWord[rr][cc]=true; }
    return true;
  }
  return false;
}
function pickSubset(a,k){const x=a.slice();for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[x[i],x[j]]=[x[j],x[i]];}return x.slice(0,Math.min(k,x.length));}

function generate(){
  rebuildLevels();

  const eligible=ALL_NAMES.filter(n=>normalize(n).length<=N);
  let names=pickSubset(eligible, Math.min(CHUNK, eligible.length));
  names.sort((a,b)=>normalize(b).length-normalize(a).length);

  board  = Array.from({length:N},()=>Array(N).fill(null));
  isWord = Array.from({length:N},()=>Array(N).fill(false));

  let placed=true;
  for(const nm of names){ if(!tryPlace(nm)){ placed=false; break; } }
  if(!placed){
    for(let attempt=0; attempt<3 && !placed; attempt++){
      names.pop();
      board  = Array.from({length:N},()=>Array(N).fill(null));
      isWord = Array.from({length:N},()=>Array(N).fill(false));
      placed=true;
      for(const nm of names){ if(!tryPlace(nm)){ placed=false; break; } }
    }
  }

  for(let r=0;r<N;r++)for(let c=0;c<N;c++) if(!board[r][c]) board[r][c]=randLetter();
  targetNames=names; remaining=new Set(names);
  buildGrid(); for(let r=0;r<N;r++)for(let c=0;c<N;c++) cells[idx(r,c)].textContent=board[r][c];
  renderTargets(); updateStatus(); refitAll(); applyHints();
}

function renderTargets(){
  const listTitle=document.getElementById('listTitle');
  listTitle.textContent=`الكلمات المستهدفة — (${targetNames.length} كلمة)`;
  targetsEl.innerHTML='';
  targetNames.forEach(n=>{ const b=document.createElement('span'); b.className='badge'; b.dataset.name=n; b.textContent=n; targetsEl.appendChild(b); });
}
function markBadgeFound(n){ [...targetsEl.children].forEach(x=>{ if(x.dataset.name===n) x.classList.add('found'); }); }
function updateStatus(){ statusEl.textContent=`المتبقي: ${remaining.size} / ${targetNames.length}`; }

/* سحب/إسقاط */
let start=null, lastPreview=[];
function posFromEl(el){ const i=+el.dataset.index; return {r:Math.floor(i/N), c:i%N}; }
function clearPreview(){ lastPreview.forEach(p=>cells[idx(p.r,p.c)].classList.remove('preview','valid-preview')); lastPreview=[]; }
function setPreview(L, exact=false){ clearPreview(); if(!L) return; L.forEach(p=>cells[idx(p.r,p.c)].classList.add(exact?'valid-preview':'preview')); lastPreview=L.slice(); }

gridEl.addEventListener('pointerdown', e=>{
  const t=e.target.closest('.cell'); if(!t) return;
  ensureAudio(); e.preventDefault(); gridEl.setPointerCapture(e.pointerId);
  start=posFromEl(t); setPreview([start], false);
});
gridEl.addEventListener('pointermove', e=>{
  if(!start) return;
  const el=document.elementFromPoint(e.clientX, e.clientY);
  const cell=(el && el.classList && el.classList.contains('cell'))? el : e.target.closest('.cell');
  if(!cell) return;
  const end=posFromEl(cell);
  const L=collectLine(start,end);
  if(!L){ clearPreview(); return; }
  const exact=isExact(L);
  if(exact){ setPreview(L, true); }
  else if(isPrefix(L)){ setPreview(L, false); }
  else{ clearPreview(); }
});
function commitIfValid(){
  if(!start || !lastPreview.length) return;
  const exactName=isExact(lastPreview);
  if(exactName){
    remaining.delete(exactName);
    lastPreview.forEach(p=>gridEl.children[idx(p.r,p.c)].classList.add('found','flash'));
    markBadgeFound(exactName); updateStatus(); playDing();
    if(remaining.size===0){ statusEl.textContent="رائع! ✅"; playWin(); }
    applyHints();
  }
  clearPreview(); start=null;
}
gridEl.addEventListener('pointerup',    ()=>commitIfValid());
gridEl.addEventListener('pointercancel',()=>{ clearPreview(); start=null; });

/* مؤثرات */
let actx=null;
function ensureAudio(){ if(!actx){ actx=new (window.AudioContext||window.webkitAudioContext)(); } }
function tone(freq, dur=0.12, type='sine', gain=0.08, when=0){
  ensureAudio(); const t=actx.currentTime+when;
  const osc=actx.createOscillator(), g=actx.createGain();
  osc.type=type; osc.frequency.value=freq;
  g.gain.value=gain; g.gain.setValueAtTime(gain,t); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  osc.connect(g).connect(actx.destination); osc.start(t); osc.stop(t+dur);
}
function playDing(){ tone(880,0.10,'triangle',0.10,0); tone(1320,0.12,'triangle',0.08,0.07); }
function playWin(){ [660,880,990,1320].forEach((f,i)=>tone(f,0.15,'square',0.09,i*0.08)); confettiBurst(); }
function confettiBurst(){
  const c=document.createElement('canvas'); c.width=innerWidth; c.height=innerHeight;
  Object.assign(c.style,{position:'fixed',inset:'0',pointerEvents:'none',zIndex:9999});
  document.body.appendChild(c);
  const ctx=c.getContext('2d'), pcs=[], cols=['#ff6b6b','#ffd166','#06d6a0','#22c55e','#3b82f6'];
  for(let i=0;i<160;i++) pcs.push({x:Math.random()*c.width,y:-20-Math.random()*200,r:6+Math.random()*6,col:cols[(Math.random()*cols.length)|0],vx:-1+Math.random()*2,vy:2+Math.random()*2,rot:Math.random()*Math.PI,vr:(-0.1+Math.random()*0.2)});
  let t=0; (function a(){ ctx.clearRect(0,0,c.width,c.height);
    pcs.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.rot+=p.vr; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.col; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore(); });
    if(t++<180) requestAnimationFrame(a); else c.remove();
  })();
}

/* تلميحات */
function applyHints(){
  for(let r=0;r<N;r++){
    for(let c=0;c<N;c++){
      const i=idx(r,c); const el=cells[i]; const isFound=el.classList.contains('found');
      el.classList.toggle('hint', hintsOn && isWord[r][c] && !isFound);
    }
  }
}
btnHints.onclick=()=>{ hintsOn=!hintsOn; btnHints.setAttribute('aria-pressed', hintsOn?'true':'false'); applyHints(); };

/* Difficulty helper */
function applyDifficulty(){
  const d=difficultySel.value;
  if(d==='easy'){ sizeSel.value='8';  chunkSel.value='6'; }
  if(d==='medium'){ sizeSel.value='10'; chunkSel.value='8'; }
  if(d==='hard'){ sizeSel.value='12'; chunkSel.value='10'; }
  N=+sizeSel.value; CHUNK=+chunkSel.value;
  gridEl.style.setProperty('--n',N);
}

/* Events */
btnRegen.onclick=()=>generate();

sizeSel.onchange=()=>{ N=+sizeSel.value; gridEl.style.setProperty('--n',N); generate(); };
chunkSel.onchange=()=>{ CHUNK=+chunkSel.value; generate(); };
difficultySel.onchange=()=>{ applyDifficulty(); generate(); };

categorySel.onchange=()=>{
  ALL_NAMES=CATEGORIES[categorySel.value].slice();
  generate();
};

/* Fit grid */
function sizeGridWrap(){
  const header=document.querySelector('header');
  const wrap=gridEl.parentElement;
  const H=Math.max(280, window.innerHeight - header.getBoundingClientRect().height - 32);
  wrap.style.setProperty('--gridH', H+'px');
}
function fitGrid(){
  const wrap=gridEl.parentElement, styles=getComputedStyle(gridEl);
  const gap=parseFloat(styles.gap)||0, W=wrap.clientWidth-6, H=wrap.clientHeight-6;
  const cW=(W-gap*(N-1))/N, cH=(H-gap*(N-1))/N;
  document.documentElement.style.setProperty('--cell', Math.floor(Math.max(26, Math.min(cW, cH)))+'px');
}
function refitAll(){ sizeGridWrap(); fitGrid(); }
window.addEventListener('resize', refitAll);
new ResizeObserver(refitAll).observe(document.body);

/* Start */
applyDifficulty();
generate();
refitAll();
</script>
</body>
</html>
