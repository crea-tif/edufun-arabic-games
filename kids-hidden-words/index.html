<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>EDUFUN â€¢ ÙƒÙ„Ù…Ø§Øª Ø®ÙÙŠØ© Ù„Ù„Ø£Ø·ÙØ§Ù„</title>
<style>
:root{
  --ink:#0f172a; --accent:#1f7ae0; --ok:#16a34a; --warn:#f59e0b;
  --glass: rgba(255,255,255,0.88);
  --bg1:#b9f3d0; --bg2:#31c77a;      /* << thÃ¨me vert */
  --cell:44px;                       /* recalculÃ© en JS */
}

/* ===== Fond & identitÃ© ===== */
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:system-ui,-apple-system,"Noto Kufi Arabic","Cairo","Tajawal",Tahoma,Arial;
  background:linear-gradient(35deg,var(--bg1) 0%, var(--bg2) 100%) fixed;
}
/* Watermark logo (aucune dÃ©pendance audio/mp3) */
body::after{
  content:""; position:fixed; inset:auto 0 16px 16px; width:150px; height:66px; z-index:-1;
  background:url("../edufun-logo-512.png") no-repeat left/contain;
  opacity:.10; pointer-events:none;
}

/* ===== Conteneurs verre dÃ©poli ===== */
header,.card{
  background:var(--glass);
  backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,0.60);
  border-radius:18px;
  box-shadow:0 10px 30px rgba(31,122,224,.18);
}
.wrap{max-width:1000px; margin:auto; padding:12px}

/* Barre du haut (non-sticky sur mobile pour ne pas rogner la grille) */
header{margin-bottom:12px}
.brandbar{display:flex;align-items:center;gap:12px}
.brand{height:60px; border-radius:10px; filter:drop-shadow(0 1px 2px rgba(0,0,0,.18))}
@media (max-width:520px){.brand{height:52px}}
h1{margin:0; font-size:22px}

.controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:8px}
select,button,label.switch{
  padding:10px 12px; border:1px solid rgba(255,255,255,0.65);
  background:#fff; border-radius:12px; font-size:14px
}
button.primary{background:#10b981; border-color:#10b981; color:#fff; box-shadow:0 6px 16px rgba(16,185,129,.25)}
.badgeBuild{margin-inline-start:8px; font-size:12px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #e7f0ff}

/* ===== Mise en page ===== */
main .wrap{display:grid; grid-template-columns:1fr 320px; gap:16px}
.grid-wrap{overflow:hidden; height:var(--gridH,70vh)}
@media (max-width:900px){
  main .wrap{grid-template-columns:1fr}
  .grid-wrap{height:var(--gridH,68vh)}
}

/* ===== Grille ===== */
.grid{
  --n:10;
  display:grid;
  grid-template-columns:repeat(var(--n),var(--cell));
  grid-auto-rows:var(--cell);
  gap:6px; padding:6px;
  user-select:none; touch-action:none;
}
.cell{
  width:var(--cell); height:var(--cell);
  display:flex; align-items:center; justify-content:center;
  background:#fff; border:1px solid #eaf1fb; border-radius:14px;
  font-weight:800;
  font-size:clamp(16px,calc(var(--cell)*.55),28px);
  transition:transform .12s,background .3s,border-color .3s;
  box-shadow:0 2px 6px rgba(31,122,224,.08);
}
.cell.preview{ outline:2px dashed #1f7ae0 }
.cell.valid-preview{ outline:2px solid var(--warn) }
.cell.hint{
  background:#fff3bf; border-color:#ffd04a;
  box-shadow:inset 0 0 0 2px #ffd04a33, 0 2px 6px rgba(31,122,224,.08)
}
.cell.found{ background:#e8f7ee; border-color:#b7e3c8; color:#055a43 }
.cell.flash{ animation:flashOk 1s ease-in-out 3 }
@keyframes flashOk{0%,100%{background:#e8f7ee}50%{background:#16a34a;color:#fff;transform:scale(1.05)}}

/* ===== Panneau latÃ©ral ===== */
aside.card{padding:14px}
h3{margin:0 0 8px}
.target{display:flex; flex-wrap:wrap; gap:8px}
.badge{background:#fff; border:1px solid #e5eefc; padding:8px 11px; border-radius:999px; font-size:14px; box-shadow:0 1px 3px rgba(31,122,224,.08)}
.badge.found{background:#e8f7ee; border-color:#b7e3c8; color:#055a43}
.help{font-size:13px; color:#29425f; line-height:1.7}
.footer{font-size:12px; color:#eef6ff; margin-top:6px; text-shadow:0 1px 2px rgba(0,0,0,.2)}
hr{border:none; border-top:1px solid #e7f0ff; margin:10px 0}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="brandbar">
      <img class="brand" src="../edufun-logo-512.png" alt="EDUFUN">
      <h1>ÙƒÙ„Ù…Ø§Øª Ø®ÙÙŠØ© Ù„Ù„Ø£Ø·ÙØ§Ù„</h1>
      <span class="badgeBuild">Build r7</span>
      <a class="badgeBuild" href="../">ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>

    <div class="controls">
      <label>Ø§Ù„ÙØ¦Ø©:
        <select id="category"></select>
      </label>
      <label>Ø§Ù„ØµØ¹ÙˆØ¨Ø©:
        <select id="difficulty">
          <option value="easy" selected>Ø³Ù‡Ù„</option>
          <option value="medium">Ù…ØªÙˆØ³Ø·</option>
          <option value="hard">ØµØ¹Ø¨</option>
        </select>
      </label>
      <label class="switch" style="display:inline-flex;gap:8px;align-items:center">
        <input type="checkbox" id="allowDiag" style="accent-color:#10b981"> Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù‚Ø·Ø±ÙŠØ§Øª
      </label>
      <button id="regen" class="primary">Ø´Ø¨ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
      <button id="toggleHints">Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ØªÙ„Ù…ÙŠØ­Ø§Øª</button>
      <span id="status" style="margin-inline-start:auto;font-size:13px;opacity:.9"></span>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <section class="card grid-wrap">
      <div id="grid" class="grid"></div>
      <div class="footer">Ø§Ø³Ø­Ø¨ Ù…Ù† Ø£ÙˆÙ„ Ø­Ø±Ù Ø¥Ù„Ù‰ Ø¢Ø®Ø±Ù‡. Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯: Ø£ÙÙ‚ÙŠ/Ø¹Ù…ÙˆØ¯ÙŠ <span id="diagNote">(Ø¨Ø¯ÙˆÙ† Ù‚Ø·Ø±ÙŠØ§Øª)</span>.</div>
    </section>

    <aside class="card">
      <h3 id="listTitle">Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</h3>
      <div class="target" id="targets"></div>
      <hr>
      <div class="help">
        ØºÙŠÙ‘Ø± â€œØ§Ù„ÙØ¦Ø©â€ Ùˆâ€Ø§Ù„ØµØ¹ÙˆØ¨Ø©â€ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰.  
        Ø³Ù‡Ù„ = 8Ã—8 Ù…Ø¹ 6â€“8 ÙƒÙ„Ù…Ø§ØªØŒ Ù…ØªÙˆØ³Ø· = 10Ã—10ØŒ ØµØ¹Ø¨ = 12Ã—12 Ù…Ø¹ ÙƒÙ„Ù…Ø§Øª Ø£ÙƒØ«Ø±.
      </div>
    </aside>
  </div>
</main>

<script>
/* ===== ÙØ¦Ø§Øª Ø§Ù„ÙƒÙ„Ù…Ø§Øª ===== */
const CATS = {
  "Ø§Ù„Ø£Ù„ÙˆØ§Ù†": ["Ø£Ø­Ù…Ø±","Ø£Ø²Ø±Ù‚","Ø£Ø®Ø¶Ø±","Ø£ØµÙØ±","Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ","Ø¨Ù†ÙØ³Ø¬ÙŠ","ÙˆØ±Ø¯ÙŠ","Ø£Ø³ÙˆØ¯","Ø£Ø¨ÙŠØ¶","Ø¨Ù†ÙŠ","Ø°Ù‡Ø¨ÙŠ","ÙØ¶ÙŠ"],
  "Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª": ["Ù‚Ø·Ø©","ÙƒÙ„Ø¨","Ø­ØµØ§Ù†","Ø¨Ù‚Ø±Ø©","ØºØ²Ø§Ù„","Ø£Ø³Ø¯","Ù†Ù…Ø±","Ø«Ø¹Ù„Ø¨","Ø¬Ù…Ù„","Ø³Ù…ÙƒØ©","Ø·ÙŠÙˆØ±","Ø¨Ø¨ØºØ§Ø¡","Ø£Ø±Ù†Ø¨","ÙÙŠÙ„","Ø²Ø±Ø§ÙØ©","Ø°Ø¦Ø¨","Ù‚Ø±Ø¯","Ù†Ø­Ù„Ø©"],
  "Ø§Ù„ÙÙˆØ§ÙƒÙ‡": ["ØªÙØ§Ø­","Ù…ÙˆØ²","Ø¨Ø±ØªÙ‚Ø§Ù„","Ø¹Ù†Ø¨","ÙØ±Ø§ÙˆÙ„Ø©","ÙƒÙ…Ø«Ø±Ù‰","Ø®ÙˆØ®","Ø±Ù…Ø§Ù†","ÙƒÙŠÙˆÙŠ","Ø¨Ø·ÙŠØ®","Ø´Ù…Ø§Ù…","ØªÙŠÙ†","Ù…Ø§Ù†Ø¬Ùˆ","Ø£Ù†Ø§Ù†Ø§Ø³"],
  "Ø§Ù„Ø®Ø¶Ø§Ø±": ["Ø·Ù…Ø§Ø·Ù…","Ø®ÙŠØ§Ø±","Ø¨Ø·Ø§Ø·Ø³","Ø¬Ø²Ø±","Ø®Ø³","ÙÙ„ÙÙ„","Ø¨ØµÙ„","Ø«ÙˆÙ…","Ù‚Ø±Ù†Ø¨ÙŠØ·","Ø¨Ø§Ø°Ù†Ø¬Ø§Ù†","Ø³Ø¨Ø§Ù†Ø®"],
  "Ø£Ø´ÙŠØ§Ø¡ Ø§Ù„ØµÙ": ["Ù‚Ù„Ù…","Ù…Ù…Ø­Ø§Ø©","Ù…Ø³Ø·Ø±Ø©","Ø¯ÙØªØ±","ÙƒØªØ§Ø¨","Ø­Ù‚ÙŠØ¨Ø©","Ø³Ø¨ÙˆØ±Ø©","Ø·Ø¨Ø§Ø´ÙŠØ±","Ù…Ø³Ù†Ù†","Ù…Ø¨Ø±Ø§Ø©","Ù…Ù‚Øµ","Ù„Ø§ØµÙ‚"],
  "ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ù†Ù‚Ù„": ["Ø³ÙŠØ§Ø±Ø©","Ø­Ø§ÙÙ„Ø©","Ø¯Ø±Ø§Ø¬Ø©","Ù‚Ø·Ø§Ø±","Ø·Ø§Ø¦Ø±Ø©","Ø³ÙÙŠÙ†Ø©","Ù…ØªØ±Ùˆ","Ø´Ø§Ø­Ù†Ø©","Ø¯Ø±Ø§Ø¬Ø© Ù†Ø§Ø±ÙŠØ©","Ù‚Ø§Ø±Ø¨"],
  "Ø§Ù„Ù…Ù„Ø§Ø¨Ø³": ["Ù‚Ù…ÙŠØµ","Ø¨Ù†Ø·Ø§Ù„","Ø­Ø°Ø§Ø¡","Ù‚Ø¨Ø¹Ø©","ÙˆØ´Ø§Ø­","ÙØ³ØªØ§Ù†","Ù…Ø¹Ø·Ù","Ø¬ÙˆØ§Ø±Ø¨","Ø­Ø²Ø§Ù…"],
  "Ø§Ù„Ø£Ø´ÙƒØ§Ù„": ["Ø¯Ø§Ø¦Ø±Ø©","Ù…Ø±Ø¨Ø¹","Ù…Ø«Ù„Ø«","Ù…Ø³ØªØ·ÙŠÙ„","Ù†Ø¬Ù…Ø©","Ù‚Ù„Ø¨","Ø¨ÙŠØ¶Ø§ÙˆÙŠ","Ù…Ø¹ÙŠÙ‘Ù†"]
};

/* ===== DOM ===== */
const gridEl = document.getElementById('grid');
const catSel  = document.getElementById('category');
const diffSel = document.getElementById('difficulty');
const chkDiag = document.getElementById('allowDiag');
const btnRegen= document.getElementById('regen');
const btnHints= document.getElementById('toggleHints');
const targetsEl = document.getElementById('targets');
const listTitle = document.getElementById('listTitle');
const statusEl  = document.getElementById('status');
const diagNote  = document.getElementById('diagNote');

/* ===== Ã‰tat ===== */
let N=10, CHUNK=8, cells=[], board=[], isWord=[], names=[], remaining=new Set(), hintsOn=false;
const AR_RANDOM="Ø§Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙŠ";
const randLetter=()=>AR_RANDOM[Math.floor(Math.random()*AR_RANDOM.length)];
const normalize=s=>s.replace(/\s+/g,'').replace(/Ù€/g,'').replace(/[^\u0600-\u06FF]/g,'');
const idx=(r,c)=>r*N+c, inBounds=(r,c)=>r>=0&&r<N&&c>=0&&c<N;

/* Remplir catÃ©gories */
Object.keys(CATS).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; catSel.appendChild(o); });
catSel.value="Ø§Ù„Ø£Ù„ÙˆØ§Ù†";

/* DifficultÃ© */
function applyDifficulty(){
  const d=diffSel.value;
  if(d==="easy"){ N=8; CHUNK=7; }
  else if(d==="medium"){ N=10; CHUNK=9; }
  else { N=12; CHUNK=12; }
  gridEl.style.setProperty('--n',N);
}

/* Construire la grille */
function buildGrid(){
  gridEl.innerHTML=''; cells=[];
  for(let i=0;i<N*N;i++){
    const d=document.createElement('div'); d.className='cell'; d.dataset.index=i;
    gridEl.appendChild(d); cells.push(d);
  }
}

/* Choisir des mots adaptÃ©s */
function pickNames(cat){
  const pool = CATS[cat].filter(w=>normalize(w).length<=N);
  const arr = pool.slice();
  for(let i=arr.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [arr[i],arr[j]]=[arr[j],arr[i]]; }
  return arr.slice(0, Math.min(CHUNK, arr.length));
}

/* Placement : H/V + diagonales si cochÃ© */
function tryPlace(word){
  const chars=normalize(word).split(''), L=chars.length;
  let dirs = [{dr:0,dc:1},{dr:0,dc:-1},{dr:1,dc:0},{dr:-1,dc:0}];
  if(chkDiag.checked){
    dirs = dirs.concat([{dr:1,dc:1},{dr:1,dc:-1},{dr:-1,dc:1},{dr:-1,dc:-1}]);
  }
  for(let t=0;t<600;t++){
    const dir = dirs[(Math.random()*dirs.length)|0];
    // bornes de dÃ©part sÃ»res selon la direction
    let r = (dir.dr<0 ? L-1 : 0) + Math.floor(Math.random()*(N - (L-1)*Math.abs(dir.dr)));
    let c = (dir.dc<0 ? L-1 : 0) + Math.floor(Math.random()*(N - (L-1)*Math.abs(dir.dc)));

    let ok=true;
    for(let k=0;k<L;k++){
      const rr=r+dir.dr*k, cc=c+dir.dc*k;
      if(!inBounds(rr,cc) || (board[rr][cc] && board[rr][cc]!==chars[k])){ ok=false; break; }
    }
    if(!ok) continue;
    for(let k=0;k<L;k++){
      const rr=r+dir.dr*k, cc=c+dir.dc*k;
      board[rr][cc]=chars[k]; isWord[rr][cc]=true;
    }
    return true;
  }
  return false;
}

/* GÃ©nÃ©ration */
function generate(){
  applyDifficulty();
  names = pickNames(catSel.value);
  names.sort((a,b)=>normalize(b).length-normalize(a).length);

  board  = Array.from({length:N},()=>Array(N).fill(null));
  isWord = Array.from({length:N},()=>Array(N).fill(false));

  let placed=true;
  for(const w of names){ if(!tryPlace(w)){ placed=false; break; } }
  if(!placed){
    while(names.length>3){
      names.pop();
      board  = Array.from({length:N},()=>Array(N).fill(null));
      isWord = Array.from({length:N},()=>Array(N).fill(false));
      placed=true;
      for(const w of names){ if(!tryPlace(w)){ placed=false; break; } }
      if(placed) break;
    }
  }

  for(let r=0;r<N;r++)for(let c=0;c<N;c++) if(!board[r][c]) board[r][c]=randLetter();

  remaining=new Set(names);
  buildGrid();
  for(let r=0;r<N;r++)for(let c=0;c<N;c++) cells[idx(r,c)].textContent=board[r][c];

  renderTargets(); updateStatus(); refitAll(); applyHints();
  diagNote.textContent = chkDiag.checked ? "(Ù…Ø¹ Ø§Ù„Ù‚Ø·Ø±ÙŠØ§Øª)" : "(Ø¨Ø¯ÙˆÙ† Ù‚Ø·Ø±ÙŠØ§Øª)";
}

/* Interface cibles */
function renderTargets(){
  targetsEl.innerHTML='';
  listTitle.textContent=`Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© â€” (${names.length} ÙƒÙ„Ù…Ø©)`;
  names.forEach(n=>{ const b=document.createElement('span'); b.className='badge'; b.dataset.name=n; b.textContent=n; targetsEl.appendChild(b); });
}
function markBadgeFound(n){ [...targetsEl.children].forEach(x=>{ if(x.dataset.name===n) x.classList.add('found'); }); }
function updateStatus(){ statusEl.textContent=`Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining.size} / ${names.length}`; }

/* Collecte du tracÃ© (suivant lâ€™option diagonales) */
function collectLine(f,t){
  const dr = Math.sign(t.r - f.r), dc = Math.sign(t.c - f.c);
  if(dr===0 && dc===0) return [{r:f.r,c:f.c}];

  if(dr!==0 && dc!==0){
    if(!chkDiag.checked) return null;              // diagonales dÃ©sactivÃ©es
    if(Math.abs(t.r - f.r) !== Math.abs(t.c - f.c)) return null; // pas alignÃ© en diag
  }else{
    if(f.r!==t.r && f.c!==t.c) return null;        // ni H ni V
  }

  const L=[]; let r=f.r, c=f.c;
  while(true){ L.push({r,c}); if(r===t.r && c===t.c) break; r+=dr; c+=dc; }
  return L;
}
function textFrom(L){ let s=''; for(const p of L) s+=board[p.r][p.c]; return s; }
function isExact(L){ const p=textFrom(L); for(const n of remaining) if(normalize(n)===p) return n; return null; }
function isPrefix(L){ const p=textFrom(L); for(const n of remaining) if(normalize(n).startsWith(p)) return true; return false; }

/* Audio Web minimal (sans fichiers) + confettis */
let actx=null;
function ensureAudio(){ if(!actx){ actx=new (window.AudioContext||window.webkitAudioContext)(); } }
function tone(freq, dur=0.12, type='sine', gain=0.09, when=0){
  ensureAudio(); const t=actx.currentTime+when;
  const o=actx.createOscillator(), g=actx.createGain();
  o.type=type; o.frequency.value=freq;
  g.gain.value=gain; g.gain.setValueAtTime(gain,t); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  o.connect(g).connect(actx.destination); o.start(t); o.stop(t+dur);
}
function ding(){ tone(880,0.10,'triangle',0.11,0); tone(1320,0.12,'triangle',0.09,0.07); }
function win(){ [660,880,990,1320].forEach((f,i)=>tone(f,0.16,'square',0.10,i*0.08)); confetti(); }
function confetti(){
  const c=document.createElement('canvas'); c.width=innerWidth; c.height=innerHeight;
  Object.assign(c.style,{position:'fixed',inset:'0',pointerEvents:'none',zIndex:9999});
  document.body.appendChild(c);
  const ctx=c.getContext('2d'), pcs=[], cols=['#ff6b6b','#ffd166','#06d6a0','#1f7ae0','#8338ec'];
  for(let i=0;i<160;i++) pcs.push({x:Math.random()*c.width,y:-20-Math.random()*200,r:6+Math.random()*6,col:cols[(Math.random()*cols.length)|0],vx:-1+Math.random()*2,vy:2+Math.random()*2,rot:Math.random()*Math.PI,vr:(-0.1+Math.random()*0.2)});
  let t=0; (function a(){ ctx.clearRect(0,0,c.width,c.height);
    pcs.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.rot+=p.vr; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.col; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore(); });
    if(t++<180) requestAnimationFrame(a); else c.remove();
  })();
}

/* SÃ©lection robuste (tactile/souris) */
let start=null, lastPreview=[];
function posFromEl(el){ const i=+el.dataset.index; return {r:Math.floor(i/N), c:i%N}; }
function clearPreview(){ lastPreview.forEach(p=>cells[idx(p.r,p.c)].classList.remove('preview','valid-preview')); lastPreview=[]; }
function setPreview(L, exact=false){ clearPreview(); if(!L) return; L.forEach(p=>cells[idx(p.r,p.c)].classList.add(exact?'valid-preview':'preview')); lastPreview=L.slice(); }
function applyHints(){
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    const el=cells[idx(r,c)], found=el.classList.contains('found');
    el.classList.toggle('hint', hintsOn && isWord[r][c] && !found);
  }
}
gridEl.addEventListener('pointerdown', e=>{
  const t=e.target.closest('.cell'); if(!t) return;
  ensureAudio(); e.preventDefault(); gridEl.setPointerCapture(e.pointerId);
  start=posFromEl(t); setPreview([start], false);
});
gridEl.addEventListener('pointermove', e=>{
  if(!start) return;
  const el=document.elementFromPoint(e.clientX, e.clientY);
  const cell=(el && el.classList && el.classList.contains('cell'))? el : e.target.closest('.cell');
  if(!cell) return;
  const end=posFromEl(cell);
  const L=collectLine(start,end);
  if(!L){ clearPreview(); return; }
  const exact=isExact(L);
  if(exact){ setPreview(L,true); }
  else if(isPrefix(L)){ setPreview(L,false); }
  else{ clearPreview(); }
});
function commitIfValid(){
  if(!start || !lastPreview.length) return;
  const exact=isExact(lastPreview);
  if(exact){
    remaining.delete(exact);
    lastPreview.forEach(p=>cells[idx(p.r,p.c)].classList.add('found','flash'));
    markBadgeFound(exact); updateStatus(); ding();
    if(remaining.size===0){ statusEl.textContent="Ø£Ø­Ø³Ù†Øª! âœ…"; win(); }
    applyHints();
  }
  clearPreview(); start=null;
}
gridEl.addEventListener('pointerup', commitIfValid);
gridEl.addEventListener('pointercancel', ()=>{ clearPreview(); start=null; });

/* Ajustements responsive â€” corrige la â€œgrille coupÃ©eâ€ (Samsung A06) */
function sizeGridWrap(){
  const vh = window.visualViewport ? window.visualViewport.height
           : Math.min(window.innerHeight, document.documentElement.clientHeight);
  const header=document.querySelector('header');
  const headerH = header ? header.getBoundingClientRect().height : 0;
  const H = Math.max(280, vh - headerH - 28);  // marge respirable
  gridEl.parentElement.style.setProperty('--gridH', H+'px');
}
function fitGrid(){
  const wrap=gridEl.parentElement, styles=getComputedStyle(gridEl);
  const gap=parseFloat(styles.gap)||0, W=wrap.clientWidth-4, H=wrap.clientHeight-4;
  const cW=(W-gap*(N-1))/N, cH=(H-gap*(N-1))/N;
  document.documentElement.style.setProperty('--cell', Math.floor(Math.max(22, Math.min(cW, cH)))+'px');
}
function refitAll(){ sizeGridWrap(); fitGrid(); }
addEventListener('resize', refitAll);
new ResizeObserver(()=>refitAll()).observe(document.body);

/* Ã‰vÃ©nements */
btnRegen.onclick = ()=>generate();
btnHints.onclick = ()=>{ hintsOn=!hintsOn; btnHints.setAttribute('aria-pressed', hintsOn?'true':'false'); applyHints(); };
catSel.onchange = ()=>generate();
diffSel.onchange= ()=>generate();
chkDiag.onchange= ()=>{ generate(); };

/* DÃ©marrage */
generate();
refitAll();
</script>
</body>
</html>
